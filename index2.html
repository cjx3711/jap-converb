<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Verbs</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
    body {
        padding-top: 70px;
        /* Required padding for .navbar-fixed-top. Remove if using .navbar-static-top. Change if height of navigation changes. */
    }
    </style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Testing</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="#">Verb Conjugator</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Content -->
    <div class="container">

        <div class="row">
            <div class="col-lg-12 text-center">
                <h1>Japanese Verb Conjugator</h1>
            </div>
            <div class="col-sm-6 col-md-4 well">
                <h2>Enter verb here:</h2>
                <p>In hiragana please</p>
                <form class="form" id="verbInput">
                    <div class="input-group">
                        <input class="form-control" type="text" id="verbField" />
                    </div>
                    <div class="input-group">
                        <input class="form-control btn btn-primary" type="submit" id="submit" value="submit"/>
                    </div>
                </form>
            </div>

            <div class="col-sm-6 col-md-8">
                <h2>Verb: <span id="verbHeader"></span></h2>
                <p id="verbInfo"></p>

                <table class="table table-bordered conjugationTable">
                    <thead>
                        <tr>
                            <th>nai form</th>
                            <th>masu form</th>
                            <th>dict form</th>
                            <th>conditional form</th>
                            <th>volitional form</th>
                            <th>te form</th>
                        </tr>
                    </thead>
                    <tbody id="conjRows">
                        <tr>
                            <td>
                                <div id="a" class="baseForm">
                                    
                                </div>
                            </td>
                            <td>
                                <div id="i" class="baseForm">
                                    
                                </div>
                            </td>
                            <td>
                                <div id="u" class="baseForm">
                                    
                                </div>
                            </td>
                            <td>
                                <div id="e" class="baseForm">
                                    
                                </div>
                            </td>
                            <td>
                                <div id="o" class="baseForm">
                                    
                                </div>
                            </td>
                            <td>
                                <div id="te" class="baseForm">
                                    
                                </div>
                            </td>
                        </tr>
                        
                    </tbody>
                </table>
            </div>

        </div>
        <!-- /.row -->

    </div>
    <!-- /.container -->

    <!-- jQuery Version 1.11.1 -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/wanakana.min.js"></script>

    <script>

    String.prototype.endsWith = function(suffix) {
        return this.indexOf(suffix, this.length - suffix.length) !== -1;
    };

    $(document).ready ( function () {
        var input = document.getElementById('verbField');
        wanakana.bind(input);

        var conjRowTemplate = $("#conjRowTemplate").html();

        $(".conjugationTable").hide();
        //$("#verbField").

        $("#verbInput").submit(function (e) {
            e.preventDefault();
            var verb = $("#verbField").val();

            if ( !wanakana.isKana(verb) ) {
                verb = wanakana.toKana(verb);
            }

            $("#verbHeader").text(verb);



            verbRomanji = wanakana.toRomaji(verb);
            console.log("Verb: " + verb + " " + verbRomanji);

            verbClass = checkType(verbRomanji);
            console.log("Class: " + verbClass);


            switch ( verbClass ) {
                case 0:
                    $("#verbInfo").text("Invalid verb");
                    $(".conjugationTable").slideUp(200);

                return;
                case 1:
                    $("#verbInfo").text("Class 1 verb");
                    conjugation = conjugateClass1(verbRomanji);
                    conjugation = furtherConjugations(conjugation);
                    fillTable(conjugation, 1);
                    $(".conjugationTable").slideDown(200);
                break;
                case 2:
                    $("#verbInfo").text("Class 2 verb");
                    conjugation = conjugateClass2(verbRomanji);
                    conjugation = furtherConjugations(conjugation);
                    fillTable(conjugation, 2);
                    $(".conjugationTable").slideDown(200);
                break;

                case 3:
                    $("#verbInfo").html("Irregular verb<br/>Feature not complete");
                    $(".conjugationTable").slideUp(200);

                break;
            }
        });

        function fillTable ( conj ) {
            $(".baseForm#a").text(wanakana.toKana(conj.a.base));
            $(".baseForm#i").text(wanakana.toKana(conj.i.base));
            $(".baseForm#u").text(wanakana.toKana(conj.u.base));
            $(".baseForm#e").text(wanakana.toKana(conj.e.base));
            $(".baseForm#o").text(wanakana.toKana(conj.o.base));
            $(".baseForm#te").text(wanakana.toKana(conj.te.base));

            maxLength = 0;
            for ( var con in conj ) {
                if ( conj[con].further.length > maxLength ) maxLength = conj[con].further.length;
            }

            $(".extendedFormRow").remove();

            for ( i = 0; i < maxLength; i++ ) {
                $("#conjRows").append($(conjRowTemplate.replace(/_ROW_/g, i )));
            }


            for ( var con in conj ) {
                consonantLength =  conj[con].further.length;
                for ( i = 0; i < consonantLength; i++ ) {
                    extended = conj[con].further[i];
                    id = con + "-" + i;
                    $("#"+id).html(extended.e+"<br/>"+wanakana.toKana(extended.j));
                }

                
                
            }



        }

        function furtherConjugations ( conjugation, verbClass ) {
            //a conjugations
            a = [];
            aBase = conjugation.a.base;
            aRoot = aBase.substring(0,aBase.length-3); //Remove the nai
            a.push({
                "e": "Please do not ...",
                "j": aBase + " dekudasai"
            });
            a.push({
                "e": "(I) may not ...",
                "j": aBase + " kamoshiremasen"
            });
            a.push({
                "e": "(I) may not ...",
                "j": aBase + " kamoshirenai"
            });
            a.push({
                "e": "(You) must ...",
                "j": aRoot + "nakereba ikemasen"
            });
            a.push({
                "e": "(You) must ...",
                "j": aRoot + "nakereba narimasen"
            });
            a.push({
                "e": "(You) don't have to ...",
                "j": aRoot + "taku temoiidesu"
            });

            //i conjugations
            i = [];
            iBase = conjugation.i.base;
            iRoot = iBase.substring(0,iBase.length-4); //Remove the masu

            i.push({
                "e": "Let's ...",
                "j": iRoot + "mashou"
            });

            i.push({
                "e": "(I) want to ...",
                "j": iRoot + "tai"
            });

            i.push({
                "e": "(I) don't want to ...",
                "j": iRoot + "takunai"
            });

            i.push({
                "e": "Why don't (we) ...",
                "j": iRoot + "masenka"
            });

            //u conjugations
            u = [];
            //e conjugations
            e = [];
            //o conjugations
            o = [];
            //te conjugations
            te = [];

            conjugation.a.further = a;
            conjugation.i.further = i;
            conjugation.u.further = u;
            conjugation.e.further = e;
            conjugation.o.further = o;
            conjugation.te.further = te;

            return conjugation;
        }

        function conjugateClass1 ( verb ) {
            console.log("Conjugating class 1");
            verbKana = wanakana.toKana(verb);
            //Handler for the special wanai case
            var endings = ["あ","い","う","え","お"];
            var additionalW = "";
            for ( i = 0 ; i < endings.length; i++ ) {
                if ( verbKana.endsWith(endings[i]) ) {
                    additionalW = "w";
                    break;
                }
            }

            //Handler for te case
            frontPart = removeLastCharacter(verb);
            consonant = frontPart[frontPart.length - 1];
            if (additionalW == "w") consonant = "w";
            console.log("Consonant: " + consonant);
            teVerb = removeLastCharacter(frontPart+additionalW);
            switch ( consonant ) {
                case "w":
                case "t":
                case "r":
                    teVerb += "tte";
                    break;
                case "k":
                    teVerb += "ite";
                    break;
                case "g":
                    teVerb += "ide";
                    break;
                case "b":
                case "m":
                    teVerb += "nde";
                    break;
                case "s":
                    teVerb += "shite";
                    break;
                default:
                    teVerb = "ERA-";
            }
            
            var ret = {
                "a": {
                    "base": removeLastCharacter(verb) + additionalW + "anai"
                },
                "i": {
                    "base": removeLastCharacter(verb) + "imasu"
                },
                "u": {
                    "base": verb
                },
                "e": {
                    "base": removeLastCharacter(verb) + "eba"
                },
                "o": {
                    "base": removeLastCharacter(verb) + "ou"
                },
                "te": {
                    "base": teVerb
                },
            }

            return ret;
        }

        function conjugateClass2 ( verb ) {
            console.log("Conjugating class 2");
            verbKana = wanakana.toKana(verb);
            verbRootKana = removeLastCharacter(verbKana);
            verbRoot = wanakana.toRomaji(verbRootKana);

            var ret = {
                "a": {
                    "base": verbRoot + "nai"
                },
                "i": {
                    "base": verbRoot + "masu"
                },
                "u": {
                    "base": verb
                },
                "e": {
                    "base": verbRoot + "reba"
                },
                "o": {
                    "base": verbRoot + "you"
                },
                "te": {
                    "base": verbRoot + "te"
                },
            }

            return ret;
        }

        //Removes the last character, unless it's a tsu, then it removes two characters
        function removeLastCharacter ( str ) {
            if ( str.endsWith("tsu") ) return str.substring(0, str.length-2);
            return str.substring(0, str.length-1);
        }

        //Returns the type of verb.
        //1 for class 1, 2 for class 2, 3 for irregular, 0 for error
        //Precondition: Must be a romanji string
        function checkType ( verb ) {
            length = verb.length;
            if ( wanakana.toKana(verb).length < 2 ) return 0;
            if ( !verb.endsWith("u") ) return 0;
            if( verb == "kuru" || verb == "suru" ) return 3;
            if ( length < 3 ) { //Possibly class 1
                if ( length < 2 ) {
                    return 0;
                }
                return 1;
            } else { //Check for iru eru ending
                if ( verb.endsWith("iru") || verb.endsWith("eru") ) return 2;
                return 1;
            }
            

        }
    });

    


    </script>

    <script type="text/template" id="conjRowTemplate">
        <tr id="row-_ROW_" class="extendedFormRow">
            <td>
                <div id="a-_ROW_" class="a extendedForms">
                    
                </div>
            </td>
            <td>
                <div id="i-_ROW_" class="i extendedForms">
                    
                </div>
            </td>
            <td>
                <div id="u-_ROW_" class="u extendedForms">
                    
                </div>
            </td>
            <td>
                <div id="e-_ROW_" class="e extendedForms">
                    
                </div>
            </td>
            <td>
                <div id="o-_ROW_" class="o extendedForms">
                    
                </div>
            </td>
            <td>
                <div id="te-_ROW_" class="te extendedForms">
                    
                </div>
            </td>
        </tr>
    </script>
</body>

</html>
